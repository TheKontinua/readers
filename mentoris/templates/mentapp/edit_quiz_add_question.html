<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Add Question To Quiz {{quiz_id}}</title>
        
        <link
        rel="stylesheet"
        type="text/css"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />

        {% load static %}
        <link rel="stylesheet" href="{% static "/css/colors.css"%}">
        <link rel="stylesheet" href="{% static "/css/quiz_styles.css"%}">

        <script src="https://cdn.jsdelivr.net/npm/latex.js/dist/latex.js"></script>
        <script src= "{% static "/scripts/toggle_attachments_visible.js" %}"></script>
        <script>
            customElements.define("latex-js", latexjs.LaTeXJSComponent);
        </script>

        <style>
            .add_question_button {
                border: 2px solid Black;
                border-radius: 25px;
                margin: 5px;
                width: 8em;
                height: 2em;
            }

            .add_question_add_state{
                background: green;
            }

            .add_question_do_not_add_state{
                background: var(--KontinuaRed); 
            }

            #quiz_content {
                width: 35em;
                padding: 10px;
                margin-bottom: 0px;
            }

        </style>

    </head>

    <body>
        <!--Include AJAX-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
        <!--Include Header-->
        <iframe src="header.html" width="100%" height="95px" frameBorder="0" style="display: block; padding: 0px; margin: 0px;"></iframe>
        
        <div id="left_panel">
        <button id="back_button" onclick="location.href='/edit_quiz/{{quiz_id}}'" type="button">Back</button>
        <div id = "quiz_content" class ="bordered">
            <ul id = "questions_list" style="list-style-type:none;">
            </ul>
        </div>
    </div>
    
    <!--Div for filters-->
    <div id = "right_panel">
        <div class="bordered" id = "meta_data">
            <div>
                <div class="form_element_wrapper">
                    <span class="form_label">Volume: </span>
                        <select id="volume_value" name="volume_value">
                        <option value = "">Any Volume</option>
                        {% for volume in volumes %}
                            <option value="{{volume.volume_id}}">{{volume.volume_id}}</option>
                        {% endfor %}
                        </select>
                </div>
                <div class="form_element_wrapper">
                    <span class="form_label">Chapter: </span>
                    <select id="chapter_value" name="chapter_value">
                        <option value = "">Any Chapter</option>
                        {% for chapter in chapters %}
                            <option value="{{chapter.chapter_id}}">{{chapter.chapter_id}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form_element_wrapper">
                    <span class="form_label">Creator: </span>
                        <select id="creator_value" name="creator_value">
                        <option value="">Any Creator</option>
                        {% for creator in creators %}
                            <option value="{{creator.user_id}}">{{creator.full_name}}</option>
                        {% endfor %}
                        </select>
                </div>
                <div class="form_element_wrapper">
                    <span class="form_label">Time (minutes): </span>
                    <input type="text" id="time_value" name="time">
                </div>
                <div class="form_element_wrapper">
                    <span class="form_label">Point Value: </span>
                    <input type="text" id="point_value">
                </div>
                <div class="form_element_wrapper">
                    <span class="form_label">Difficulty: </span>
                    <input type="text" id="difficulty_value">
                </div>
            </div>
        </div>
        <button id="save_changes_button">Save Additions</button>
        <button id="filter_button">Search</button>
        <div id="save_status" class="bordered"></div>        
    </div>

    <iframe src="footer.html" width="100%" frameBorder="0"></iframe>


        <script type = "text/javascript">

            // Toggle add button between two states, indicated by label 
            // and class
            function toggle_add(button){
                if($(button).hasClass("add_question_do_not_add_state")){
                    $(button).text("Add");
                    $(button).removeClass("add_question_do_not_add_state")
                    $(button).addClass("add_question_add_state")
                }else if($(button).hasClass("add_question_add_state")){
                    $(button).text("Do Not Add");
                    $(button).addClass("add_question_do_not_add_state")
                    $(button).removeClass("add_question_add_state")
                }
            }

            // Make attribute label with a given name, associated
            // class and value
            function make_attribute_label(name, value_class, value){
                var p = document.createElement("p");
                $(p).addClass("small_margin");

                var span_title = document.createElement("span");
                $(span_title).addClass("bold_font");
                span_title.innerHTML = name;

                var span_value = document.createElement("span");
                span_value.innerHTML = value;
                $(span_value).addClass(value_class)

                p.appendChild(span_title);
                p.appendChild(span_value);
                return p;
            }


            $(document).ready(function() {

                $('.add_question_button').on('click', function(event){
                    toggle_add(this);
                });

                // Dynamicly create each question when filter is pressed
                $('#filter_button').on('click', function(event){
                    volume_value = document.getElementById('volume_value').value;
                    chapter_value = document.getElementById('chapter_value').value;
                    point_value = document.getElementById("point_value").value;
                    creator_value = document.getElementById('creator_value').value;
                    time_value = document.getElementById('time_value').value;
                    difficulty_value = document.getElementById('difficulty_value').value;

                    var request = $.ajax({
                        type: "GET",
                        url: "/edit_quiz_add_question/{{quiz_id}}",
                        dataType: 'json',
                        data:{
                            csrfmiddlewaretoken: "{{csrf_token}}",
                            command: "filter",
                            chapter: chapter_value,
                            volume: volume_value,
                            creator: creator_value,
                            time: time_value,
                            point: point_value,
                            difficulty: difficulty_value 
                        }
                    });
                    request.done(function(data){
                        document.getElementById("questions_list").innerHTML = "";
                        for(const i in data){
                            var list_item = document.createElement("li");
                            list_item.id = data[i]["question_id"];
                            
                            // border for each question
                            var border_wrapper = document.createElement("div");
                            $(border_wrapper).addClass("bordered");
                        
                            // wrapper containing question meta data
                            var question_wrapper = document.createElement("div");
                            question_wrapper.style.float = "left";
                            question_wrapper.appendChild(make_attribute_label("Difficulty: ", "conceptual_difficulty", data[i]["conceptual_difficulty"]));
                            question_wrapper.appendChild(make_attribute_label("Volume: ", "volume", data[i]["volume"]));
                            question_wrapper.appendChild(make_attribute_label("Chapter: ", "chapter", data[i]["chapter"]));
                            question_wrapper.appendChild(make_attribute_label("Creator: ", "creator", data[i]["creator"]));
                            question_wrapper.appendChild(make_attribute_label("Point Value: ", "point_value", data[i]["point_value"]));
                            question_wrapper.appendChild(make_attribute_label("Time (minutes): ", "time_required_mins", data[i]["time_required_mins"]));
                            border_wrapper.appendChild(question_wrapper);

                            // wrapper for add button
                            var button_wrapper = document.createElement("div");
                            button_wrapper.style.float = "right";

                            // add button
                            var add_button = document.createElement("button");
                            add_button.innerHTML = "Add";
                            add_button.addEventListener('click', function(event){
                                toggle_add(event.target);
                            });
                            $(add_button).addClass("add_question_button");
                            $(add_button).addClass("add_question_add_state");
                            $(add_button).addClass("bold_font");
                            button_wrapper.appendChild(add_button);
                            border_wrapper.appendChild(button_wrapper);

                            // latex wrapper
                            var latex_wrapper = document.createElement("div");
                            latex_wrapper.style.clear = "both";
                            
                            // latex display
                            var latex = document.createElement("latex-js");
                            latex.innerHTML=  data[i]["question_latex"] 
                            latex_wrapper.appendChild(latex);
                            border_wrapper.appendChild(latex_wrapper);

                            // show attachments and toggle if at least 1 attachment exists 
                            if(data[i]["attachment_urls"].length > 0){
                                var attachment_button_wrapper = document.createElement("div");
                                attachment_button_wrapper.style.float = "right";
                                attachment_button = document.createElement("button");
                                attachment_button.innerHTML = "Show Attachments";
                                $(attachment_button).addClass("bold_font");
                                attachment_button_wrapper.appendChild(attachment_button);

                                attachment_button.addEventListener('click', function(event){
                                    toggle_attachments_visible("questions_list", event.target, "attachments");
                                });

                                border_wrapper.appendChild(attachment_button_wrapper);
                            
                                var attachment_wrapper = document.createElement("div");
                                $(attachment_wrapper).addClass("bordered")
                                $(attachment_wrapper).addClass("attachments")
                                $(attachment_wrapper).addClass("invisible_state")
                                attachment_wrapper.style.clear = "both";
                                attachment_wrapper.style.display = "none";
                                border_wrapper.appendChild(attachment_wrapper);

                                for(const j in data[i]["attachment_urls"]){
                                    var image = document.createElement("img");
                                    image.src = data[i]["attachment_urls"][j];
                                    image.width = "200";
                                    image.style.position = "relative";
                                    image.style.left = "25%";
                                    attachment_wrapper.appendChild(image);
                                }
                            }
                            list_item.appendChild(border_wrapper);
                            document.getElementById("questions_list").appendChild(list_item);
                        }
                    });
 
                    request.fail(function(){
                        document.getElementById("questions_list").innerHTML = "Search failed, try again";
                    });
                });

            $('#save_changes_button').on('click', function(event){
                var list = document.getElementById("questions_list").children;
                var question_id_list = [];
                for(var i = 0; i < list.length; ++i){
                    let add_button = list[i].getElementsByClassName("add_question_button")[0];
                    if( $(add_button).hasClass("add_question_do_not_add_state")){
                        question_id_list.push($(list[i]).attr("id"));
                    }   
                }

                var request = $.ajax({
                    type: "POST",
                    url: "/edit_quiz_add_question/{{quiz_id}}",
                    dataType: 'json',
                    data:{
                        csrfmiddlewaretoken: "{{csrf_token}}",
                        command: "save_changes",
                        questions_to_add_ids: JSON.stringify(question_id_list),
                    }
                });

                request.done(function(){
                    const save_status = document.getElementById("save_status");
                    const save_date = new Date();
                    save_status.innerHTML = "Additions Saved at " + save_date.toString();
                });

                request.fail(function(){
                    const save_status = document.getElementById("save_status");
                    const save_date = new Date();
                    save_status.innerHTML = "Oh no! There was an error making additions at: " + save_date.toString();
                });
            });
        });
        </script>
        
    </body>

</html>